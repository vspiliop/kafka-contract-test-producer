


























































































































<!DOCTYPE html>
<!--
 Generated by Apache Maven Doxia the 2023-02-22
 Rendered using Docs Maven Skin 2.3.1 (https://github.com/Bernardo-MG/docs-maven-skin)
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>kafka-contract-test-producer &#x2013; Contract testing for Kafka event based services</title>
    <link href="./favicon.ico" rel="shortcut icon" type="image/x-icon">

    <!-- Metadata -->
    <meta name="description" content="Contract testing for event based services using Avro as the message format">
    <meta name="keywords" content="Contract Testing">
    <meta name="author" content="Vassilis Spiliopoulos">

    <!-- Facebook Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="kafka-contract-test-producer &#x2013; Contract testing for Kafka event based services">
    <meta property="og:title" content="kafka-contract-test-producer &#x2013; Contract testing for Kafka event based services">
    <meta property="og:description" content="Contract testing for event based services using Avro as the message format">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:creator" content="@vspiliop">
    <meta name="twitter:title" content="kafka-contract-test-producer &#x2013; Contract testing for Kafka event based services">
    <meta name="twitter:description" content="Contract testing for event based services using Avro as the message format">

    <!-- CSS -->
    <link rel="stylesheet" href="./lib/bootswatch/dist/litera/bootstrap.min.css">
    <link rel="stylesheet" href="./lib/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="./lib/highlight/styles/default.css">
    <!-- Docs Template style -->
    <link rel="stylesheet" href="./css/style.min.css">
    



</head>
<body class="d-flex flex-column">
<header>
    <nav id="navbar-main" class="navbar navbar-expand-md navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">kafka-contract-test-producer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-main-menu" aria-controls="navbar-main" aria-expanded="false" aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
            </button>
        
            <small class="navbar-text d-none d-md-block"><span id="navbar-version">0.0.1-SNAPSHOT</span> (<time id="navbar-date">

2023-02-22</time>)</small>



























            <div class="col-sm d-none d-md-block">
            <a href="https://github.com/vspiliop/kafka-contract-test-producer" title="Github" aria-label="Github"><span class="navbar-icon fab fa-github ps-1" aria-hidden="true"></span> <span class="d-none d-sm-block d-md-none"> Github</span></a>



            </div>
            <div class="collapse navbar-collapse" id="navbar-main-menu">
                <ul class="nav navbar-nav ms-auto">


                    <li class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" id="Documentation_menu" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation</a>
                        <ul class="dropdown-menu dropdown-menu-end" role="menu" aria-labelledby="Documentation_menu">
                            <li><a class="dropdown-item" href="./summary.html" title="Project Summary" aria-label="Project Summary">Project Summary</a></li>
                            <li><a class="dropdown-item" href="./dependencies.html" title="Dependencies" aria-label="Dependencies">Dependencies</a></li>
                            <li><a class="dropdown-item" href="./plugins.html" title="Plugins" aria-label="Plugins">Plugins</a></li>
                            <li><a class="dropdown-item" href="./project-info.html" title="Site Map" aria-label="Site Map">Site Map</a></li>
                            <li><a class="dropdown-item" href="./team.html" title="Team" aria-label="Team">Team</a></li>

                        </ul>
                    </li>


                </ul>
            </div>
        </div>
    </nav>
</header>
<main>
    <section id="main-section" class="container flex-grow-1">
<header class="pb-2 mt-4 mb-2 border-bottom">
 <h1 id="Contract-testing-for-Kafka-event-based-services">Contract testing for Kafka event based services</h1>
</header>
<h1 id="Table-of-Contents">Table of Contents</h1><!-- TOC -->
<ul>
 <li><a href="#Contract-testing-for-kafka-event-based-services">Contract testing for Kafka event based services</a></li>
 <li><a href="#Table-of-contents">Table of Contents</a></li>
 <li><a href="#Key-takeaway">Key takeaway</a></li>
 <li><a href="#Why">Why</a></li>
 <li><a href="#The-bigger-picture">The bigger picture</a></li>
 <li><a href="#Effective-communication-requirements">Effective communication requirements</a>
  <ul>
   <li><a href="#Consumer-can-read-producer-data">Consumer can read producer data</a></li>
   <li><a href="#Consumer-can-deliver-business-value">Consumer can deliver business value</a>
    <ul>
     <li><a href="#Component-tests">Component tests</a>
      <ul>
       <li><a href="#Consumer">Consumer</a></li>
       <li><a href="#Producer">Producer</a></li>
      </ul></li>
     <li><a href="#Contract-tests-to-the-rescue">Contract tests to the rescue</a>
      <ul>
       <li><a href="#Producer-1">Producer</a></li>
       <li><a href="#Consumer-1">Consumer</a></li>
      </ul></li>
    </ul></li>
  </ul></li>
 <li><a href="#Show-me-the-code">Show me the code</a></li>
 <li><a href="#Whats-next">What's next?</a></li>
</ul><!-- TOC -->
<table class="table table-striped table-bordered">
 <thead>
  <tr>
   <th>Disclaimer</th>
  </tr>
 </thead>
 <tbody>
  <tr>
   <td align="left">Opinionated content follows :-)</td>
  </tr>
 </tbody>
</table>
<h1 id="Key-takeaway">Key takeaway</h1>
<p>.. and target of this presentation is try to persuade you that:</p>
<p><code>Contracts tests are a promising and effective way to reduce end-to-end tests.</code></p>
<h1 id="Why">Why</h1>
<p>.. reduce the number of end-to-end tests?</p>
<ul>
 <li>Slow</li>
 <li>Brittle</li>
 <li>Expensive to set up and maintain</li>
 <li>We cannot do exhaustive testing</li>
 <li>Slow feedback 
  <ul>
   <li>No build time feedback</li>
  </ul></li>
 <li>Which team owns the end-to-end test? 
  <ul>
   <li>writing</li>
   <li>fixing</li>
   <li>maintaining</li>
  </ul></li>
</ul>
<h1 id="The-bigger-picture">The bigger picture</h1>
<p>Contract tests sit between end-to-end and component tests.</p>
<div class="d-inline-flex">
 <figure class="shadow bg-white rounded p-2">
  <img src="images/src/main/plantuml/testing-pyramid.png" alt="" class="img-fluid">
  <figcaption class="font-italic">
  </figcaption>
 </figure>
</div>
<h1 id="Effective-communication-requirements">Effective communication requirements</h1>
<p>Focusing on Instrument and Streams services.</p>
<ol style="list-style-type: decimal">
 <li>Streams can de-serialise the event/ bytes, serialised by Instruments</li>
 <li>The de-serialised event contains all necessary data for Streams to perform its business logic (has the proper semantics)</li>
</ol>
<ul>
 <li>(1) and (2) though related, are not the same!</li>
 <li>A consumer able to de-serialise, does not mean it can deliver its business purpose 
  <ul>
   <li>Avro required fields capture what is required from an event modelling perspective, not the consumer</li>
   <li>One contract <code>per consumer</code> or <code>per consumer, per consumer use case</code> would be better? 
    <ul>
     <li>Different consumers may require different fields</li>
     <li>Different consumers may require different values of the same Enum field</li>
    </ul></li>
   <li>Doing compatible avro schema changes usually leads to reducing avro required fields</li>
  </ul></li>
</ul>
<div class="d-inline-flex">
 <figure class="shadow bg-white rounded p-2">
  <img src="images/src/main/plantuml/producer-consumer.png" alt="" class="img-fluid">
  <figcaption class="font-italic">
  </figcaption>
 </figure>
</div>
<section>
 <h2 id="Consumer-can-read-producer-data"><a name="Consumer_can_read_producer_data"></a>Consumer can read producer data</h2>
 <p>The avro schemas used by the <code>Streams Consumer</code> and <code>Instruments Producer</code> are compatible, so that <code>Streams</code> can de-serialise the bytes, serialised by <code>Instruments</code>.</p>
 <div class="d-inline-flex">
  <figure class="shadow bg-white rounded p-2">
   <img src="images/schema-compatibility-matrix.pdf" width="650" alt="" class="img-fluid">
   <figcaption class="font-italic">
   </figcaption>
  </figure>
 </div>
</section>
<section>
 <h2 id="Consumer-can-deliver-business-value"><a name="Consumer_can_deliver_business_value"></a>Consumer can deliver business value</h2>
 <p>The de-serialised event contains all necessary data for <code>Streams</code> to perform its business logic (has the proper semantics).</p>
 <section>
  <h3 id="Component-tests"><a name="Component_tests"></a>Component tests</h3>
  <p>Currently, we do a lot of them.</p>
  <section>
   <h4 id="Consumer"><a name="Consumer"></a>Consumer</h4>
   <div class="d-inline-flex">
    <figure class="shadow bg-white rounded p-2">
     <img src="images/src/main/plantuml/consumer-component-test.png" alt="" class="img-fluid">
     <figcaption class="font-italic">
     </figcaption>
    </figure>
   </div>
   <p>Pros:</p>
   <ul>
    <li>Exist on the Streams (consumer) bitbucket repo</li>
    <li>Run as part of the build process</li>
    <li>Fast</li>
    <li>Stable</li>
    <li>Isolated</li>
    <li>Easy to set up</li>
   </ul>
   <p>Cons:</p>
   <ul>
    <li>Test mocks the actual producer</li>
    <li>Stall mocks issues! 
     <ul>
      <li>Instruments (i.e. actual runtime producer) moves to a new esp-kafka-schemas version</li>
      <li>Instruments service removes an avro optional field that is required from the Streams (i.e. consumer) perspective</li>
     </ul></li>
   </ul>
  </section>
  <section>
   <h4 id="Producer"><a name="Producer"></a>Producer</h4>
   <div class="d-inline-flex">
    <figure class="shadow bg-white rounded p-2">
     <img src="images/src/main/plantuml/producer-component-test.png" alt="" class="img-fluid">
     <figcaption class="font-italic">
     </figcaption>
    </figure>
   </div>
   <p>Pros:</p>
   <ul>
    <li>Exist on the Instrument (producer) bitbucket repo</li>
    <li>Run as part of the build process</li>
    <li>Fast</li>
    <li>Stable</li>
    <li>Isolated</li>
    <li>Easy to set up</li>
   </ul>
   <p>Cons:</p>
   <ul>
    <li>How does the producer know that it emits events that are actually what the consumer expects? I does not. 
     <ul>
      <li>Streams requires a particular value of an enum field (e.g. <code>status</code> to be <code>FULFILLED</code>), but the producer never generates a <code>FULFILLED</code> event?</li>
     </ul></li>
   </ul>
  </section>
 </section>
 <section>
  <h3 id="Contract-tests-to-the-rescue"><a name="Contract_tests_to_the_rescue"></a>Contract tests to the rescue</h3>
  <section>
   <h4 id="Producer"><a name="Producer"></a><a name="Producer-1" id="Producer-1"></a> Producer</h4>
   <div class="d-inline-flex">
    <figure class="shadow bg-white rounded p-2">
     <img src="images/src/main/plantuml/producer-contract-test.png" alt="" class="img-fluid">
     <figcaption class="font-italic">
     </figcaption>
    </figure>
   </div>
   <p>Pros:</p>
   <ul>
    <li>Exist on the Instrument (producer) bitbucket repo</li>
    <li>Run as part of the build process</li>
    <li>Fast</li>
    <li>Stable</li>
    <li>Isolated</li>
    <li>Easy to set up</li>
   </ul>
   <p>2 extras:</p>
   <ul>
    <li>If producer by mistake stops following the contract producer build fails!</li>
    <li>Meaning, the producer emits events that the consumers actually expect</li>
   </ul>
  </section>
  <section>
   <h4 id="Consumer"><a name="Consumer"></a><a name="Consumer-1" id="Consumer-1"></a> Consumer</h4>
   <div class="d-inline-flex">
    <figure class="shadow bg-white rounded p-2">
     <img src="images/src/main/plantuml/consumer-contract-test.png" alt="" class="img-fluid">
     <figcaption class="font-italic">
     </figcaption>
    </figure>
   </div>
   <p>Pros:</p>
   <ul>
    <li>Exist on the Instrument (producer) bitbucket repo</li>
    <li>Run as part of the build process</li>
    <li>Fast</li>
    <li>Stable</li>
    <li>Isolated</li>
    <li>Easy to set up</li>
   </ul>
   <p>and an extra one:</p>
   <ul>
    <li>No stall mocks issue!</li>
   </ul>
   <header class="pb-2 mt-4 mb-2 border-bottom">
    <h1 id="Show-me-the-code">Show me the code</h1>
   </header>
   <p>Open Intellij..</p>
   <h1 id="Whats-next">What's next?</h1>
   <ul>
    <li>Should the producer have a contract per consumer's use case scenario? 
     <ul>
      <li>The consuming service uses the sample event as is for testing these use cases</li>
     </ul></li>
    <li>Maybe contract tests should focus on verifying just event structure</li>
    <li>Is there any benefit of using avro, regarding schema evolution, if you do contract testing?</li>
    <li>Someone has to do a POC of the whole dev process: from Pull Request to DVA and beyond..</li>
    <li>What about non JVM producers/ consumer? 
     <ul>
      <li>OTPm is a C++ Kafka producer</li>
      <li>MMC UI is a Nodejs REST consumer</li>
     </ul></li>
   </ul>
  </section>
 </section>
</section>
    </section>
</main>
<footer class="footer w-100 pt-2 border-top bg-light">
    <div id="footer-nav" class="bg-light container">
















        <div id="navbar-footer" class="row">
            <div class="col">
    <dl class="text-center mb-1">
    <dt class="border-bottom">General Info</dt>

              <dd><a href="./acquire.html" title="Acquire" aria-label="Acquire">Acquire</a></dd>

              <dd><a href="./usage.html" title="Usage" aria-label="Usage">Usage</a></dd>

              <dd><a href="./changes-report.html" title="Changes Log" aria-label="Changes Log">Changes Log</a></dd>


    </dl>

            </div>

            <div class="col">
    <dl class="text-center mb-1">
    <dt class="border-bottom">Code</dt>

              <dd><a href="https://github.com/vspiliop/kafka-contract-test-producer" title="SCM" aria-label="SCM" class="link-noted">SCM <span class="note">GitHub</span></a></dd>

              <dd><a href="https://github.com/vspiliop/kafka-contract-test-producer/actions" title="CI" aria-label="CI" class="link-noted">CI <span class="note">Github Actions</span></a></dd>

              <dd><a href="https://github.com/vspiliop/kafka-contract-test-producer/issues" title="Issues" aria-label="Issues" class="link-noted">Issues <span class="note">GitHub</span></a></dd>


    </dl>

            </div>

            <div class="col">
    <dl class="text-center mb-1">
    <dt class="border-bottom">Releases</dt>

              <dd><a href="https://mvnrepository.com/artifact/com.github.vspiliop/kafka-contract-test-producer" title="Maven Central" aria-label="Maven Central">Maven Central</a></dd>

              <dd><a href="https://github.com/vspiliop?tab=packages&repo_name=kafka-contract-test-producer" title="GitHub" aria-label="GitHub">GitHub</a></dd>


    </dl>

            </div>



        </div>
    </div>
    <div id="footer-info" class="bg-light ps-2 pb-1 w-100">
        <div>
 <span class="far fa-copyright"></span>2022-2023



<a href="https://uk.linkedin.com/in/vassilis-spiliopoulos-578343a">Vassilis Spiliopoulos</a>


-

<a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a> 



</div>
        <div>Rendered using <a href="https://github.com/Bernardo-MG/docs-maven-skin">Docs Maven Skin</a> 2.3.1</div>
    </div>
</footer>
<script src="./lib/popperjs/core/dist/umd/popper.min.js"></script>
<script src="./lib/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="./lib/highlight/highlight.pack.js"></script>
<script src="./js/initializeHighlight.js"></script>
</body>
</html>